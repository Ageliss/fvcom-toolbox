<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of write_FVCOM_forcing</title>
  <meta name="keywords" content="write_FVCOM_forcing">
  <meta name="description" content="Write data out to FVCOM NetCDF forcing file.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">fvcom_prepro</a> &gt; write_FVCOM_forcing.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for fvcom_prepro&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>write_FVCOM_forcing
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Write data out to FVCOM NetCDF forcing file.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function write_FVCOM_forcing(Mobj, fileprefix, data, infos, fver) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Write data out to FVCOM NetCDF forcing file.
 
 write_FVCOM_forcing(fvcom_forcing_file, data, infos, fver)
 
 DESCRIPTION:
   Takes the given interpolated data (e.g. from grid2fvcom) and writes out
   to a NetCDF file.
 
 INPUT:
   Mobj - MATLAB mesh object
   fileprefix - Output NetCDF file prefix (plus path) will be
       fileprefix_{wnd,hfx,evap}.nc if fver is '3.1.0', otherwise output
       files will be fileprefix_wnd.nc.
   data - Struct of the data to be written out.
   infos - Additional remarks to be written to the &quot;infos&quot; NetCDF variable
   fver - Output for version 3.1.0 or 3.1.6. The latter means all the
       forcing can go in a single file, the former needs separate files
       for specific forcing data (wind, heating and precipitation).
 
 The fields in data may be called any of:
     - 'u10', 'v10', 'uwnd', 'vwnd' - wind components
     - 'P_E'       - evaporation
     - 'prate'     - precipitation
     - 'nswrs'     - short wave radiation
     - 'shtfl'\
     - 'lhtfl' &gt;   - combine to form &quot;surface net heat flux&quot;
     - 'nlwrs'/
     - 'time'
     - 'lon'
     - 'lat'
     - 'x'
     - 'y'
 
 OUTPUT:
   FVCOM wind speed forcing NetCDF file(s)
 
 
 Author(s):
   Pierre Cazenave (Plymouth Marine Laboratory)
 
 Revision history:
   2012-11-01 - First version based on the parts of grid2fvcom_U10V10.m
   which dealt with writing the NetCDF file. This version now dynamically
   deals with varying numbers of forcing data.
   2012-11-09 - Add the correct calculation for the surface net heat flux.
 
==========================================================================</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="nodes2elems.html" class="code" title="function [fieldout]  = nodes2elems(fieldin,Mobj)">nodes2elems</a>	Transfer a field from vertices to elements</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function write_FVCOM_forcing(Mobj, fileprefix, data, infos, fver)</a>
0002 <span class="comment">% Write data out to FVCOM NetCDF forcing file.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% write_FVCOM_forcing(fvcom_forcing_file, data, infos, fver)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% DESCRIPTION:</span>
0007 <span class="comment">%   Takes the given interpolated data (e.g. from grid2fvcom) and writes out</span>
0008 <span class="comment">%   to a NetCDF file.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% INPUT:</span>
0011 <span class="comment">%   Mobj - MATLAB mesh object</span>
0012 <span class="comment">%   fileprefix - Output NetCDF file prefix (plus path) will be</span>
0013 <span class="comment">%       fileprefix_{wnd,hfx,evap}.nc if fver is '3.1.0', otherwise output</span>
0014 <span class="comment">%       files will be fileprefix_wnd.nc.</span>
0015 <span class="comment">%   data - Struct of the data to be written out.</span>
0016 <span class="comment">%   infos - Additional remarks to be written to the &quot;infos&quot; NetCDF variable</span>
0017 <span class="comment">%   fver - Output for version 3.1.0 or 3.1.6. The latter means all the</span>
0018 <span class="comment">%       forcing can go in a single file, the former needs separate files</span>
0019 <span class="comment">%       for specific forcing data (wind, heating and precipitation).</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% The fields in data may be called any of:</span>
0022 <span class="comment">%     - 'u10', 'v10', 'uwnd', 'vwnd' - wind components</span>
0023 <span class="comment">%     - 'P_E'       - evaporation</span>
0024 <span class="comment">%     - 'prate'     - precipitation</span>
0025 <span class="comment">%     - 'nswrs'     - short wave radiation</span>
0026 <span class="comment">%     - 'shtfl'\</span>
0027 <span class="comment">%     - 'lhtfl' &gt;   - combine to form &quot;surface net heat flux&quot;</span>
0028 <span class="comment">%     - 'nlwrs'/</span>
0029 <span class="comment">%     - 'time'</span>
0030 <span class="comment">%     - 'lon'</span>
0031 <span class="comment">%     - 'lat'</span>
0032 <span class="comment">%     - 'x'</span>
0033 <span class="comment">%     - 'y'</span>
0034 <span class="comment">%</span>
0035 <span class="comment">% OUTPUT:</span>
0036 <span class="comment">%   FVCOM wind speed forcing NetCDF file(s)</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% Author(s):</span>
0040 <span class="comment">%   Pierre Cazenave (Plymouth Marine Laboratory)</span>
0041 <span class="comment">%</span>
0042 <span class="comment">% Revision history:</span>
0043 <span class="comment">%   2012-11-01 - First version based on the parts of grid2fvcom_U10V10.m</span>
0044 <span class="comment">%   which dealt with writing the NetCDF file. This version now dynamically</span>
0045 <span class="comment">%   deals with varying numbers of forcing data.</span>
0046 <span class="comment">%   2012-11-09 - Add the correct calculation for the surface net heat flux.</span>
0047 <span class="comment">%</span>
0048 <span class="comment">%==========================================================================</span>
0049 
0050 multi_out = false; <span class="comment">% default to 3.1.6, single output file</span>
0051 <span class="keyword">if</span> nargin &lt; 4 || nargin &gt; 5
0052     error(<span class="string">'Incorrect number of arguments'</span>)
0053 <span class="keyword">elseif</span> nargin == 5
0054     <span class="keyword">if</span> strcmpi(fver, <span class="string">'3.1.0'</span>)
0055         multi_out = true;
0056     <span class="keyword">end</span>
0057 <span class="keyword">end</span>
0058 
0059 subname = <span class="string">'write_FVCOM_forcing'</span>;
0060 
0061 <span class="keyword">global</span> ftbverbose;
0062 <span class="keyword">if</span>(ftbverbose)
0063   fprintf(<span class="string">'\n'</span>)
0064   fprintf([<span class="string">'begin : '</span> subname <span class="string">'\n'</span>])
0065 <span class="keyword">end</span>
0066 
0067 tri = Mobj.tri;
0068 nNodes = Mobj.nVerts;
0069 nElems = Mobj.nElems;
0070 ntimes = numel(data.time);
0071 
0072 <span class="keyword">if</span> strcmpi(Mobj.nativeCoords,<span class="string">'cartesian'</span>)
0073     x = Mobj.x;
0074     y = Mobj.y;
0075 <span class="keyword">else</span>
0076     x = Mobj.lon;
0077     y = Mobj.lat;
0078 <span class="keyword">end</span>
0079 
0080 <span class="comment">% Create element vertices positions</span>
0081 xc = <a href="nodes2elems.html" class="code" title="function [fieldout]  = nodes2elems(fieldin,Mobj)">nodes2elems</a>(x, Mobj);
0082 yc = <a href="nodes2elems.html" class="code" title="function [fieldout]  = nodes2elems(fieldin,Mobj)">nodes2elems</a>(y, Mobj);
0083 
0084 <span class="comment">%--------------------------------------------------------------------------</span>
0085 <span class="comment">% Create the NetCDF header for the FVCOM forcing file</span>
0086 <span class="comment">%--------------------------------------------------------------------------</span>
0087 
0088 <span class="keyword">if</span> multi_out
0089     suffixes = {<span class="string">'_wnd'</span>, <span class="string">'_hfx'</span>, <span class="string">'_evap'</span>};
0090 <span class="keyword">else</span>
0091     suffixes = {<span class="string">'_wnd'</span>};
0092 <span class="keyword">end</span>
0093 
0094 <span class="keyword">for</span> i=1:length(suffixes)
0095 
0096     nc = netcdf.create([fileprefix, suffixes{i}, <span class="string">'.nc'</span>], <span class="string">'clobber'</span>);
0097 
0098 <span class="comment">%     netcdf.putAtt(nc,netcdf.getConstant('NC_GLOBAL'),'type','FVCOM Forcing File')</span>
0099     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'title'</span>,<span class="string">'FVCOM Forcing File'</span>)
0100     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'institution'</span>,<span class="string">'Plymouth Marine Laboratory'</span>)
0101     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'source'</span>,<span class="string">'FVCOM grid (unstructured) surface forcing'</span>)
0102     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'history'</span>,[<span class="string">'File created on '</span>, datestr(now, <span class="string">'yyyy-mm-dd HH:MM:SS'</span>), <span class="string">' with write_FVCOM_forcing.m from the fvcom-toolbox (https://github.com/pwcazenave/fvcom-toolbox)'</span>])
0103     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'references'</span>,<span class="string">'http://fvcom.smast.umassd.edu, http://codfish.smast.umassd.edu'</span>)
0104     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'Conventions'</span>,<span class="string">'CF-1.0'</span>)
0105 <span class="comment">%     netcdf.putAtt(nc,netcdf.getConstant('NC_GLOBAL'),'infos',infos)</span>
0106     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'CoordinateSystem'</span>,Mobj.nativeCoords)
0107     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'CoordinateProjection'</span>,<span class="string">'init=epsg:4326'</span>) <span class="comment">% WGS84?</span>
0108 
0109     <span class="comment">% Dimensions</span>
0110     nele_dimid=netcdf.defDim(nc,<span class="string">'nele'</span>,nElems);
0111     node_dimid=netcdf.defDim(nc,<span class="string">'node'</span>,nNodes);
0112     three_dimid=netcdf.defDim(nc,<span class="string">'three'</span>,3);
0113     time_dimid=netcdf.defDim(nc,<span class="string">'time'</span>,netcdf.getConstant(<span class="string">'NC_UNLIMITED'</span>));
0114     datestrlen_dimid=netcdf.defDim(nc,<span class="string">'DateStrLen'</span>,26);
0115 
0116     <span class="comment">% Space variables</span>
0117     x_varid=netcdf.defVar(nc,<span class="string">'x'</span>,<span class="string">'NC_FLOAT'</span>,node_dimid);
0118     netcdf.putAtt(nc,x_varid,<span class="string">'long_name'</span>,<span class="string">'nodal x-coordinate'</span>);
0119     netcdf.putAtt(nc,x_varid,<span class="string">'units'</span>,<span class="string">'meters'</span>);
0120 
0121     y_varid=netcdf.defVar(nc,<span class="string">'y'</span>,<span class="string">'NC_FLOAT'</span>,node_dimid);
0122     netcdf.putAtt(nc,y_varid,<span class="string">'long_name'</span>,<span class="string">'nodal y-coordinate'</span>);
0123     netcdf.putAtt(nc,y_varid,<span class="string">'units'</span>,<span class="string">'meters'</span>);
0124     
0125     xc_varid=netcdf.defVar(nc,<span class="string">'xc'</span>,<span class="string">'NC_FLOAT'</span>,nele_dimid);
0126     netcdf.putAtt(nc,xc_varid,<span class="string">'long_name'</span>,<span class="string">'zonal x-coordinate'</span>);
0127     netcdf.putAtt(nc,xc_varid,<span class="string">'units'</span>,<span class="string">'meters'</span>);
0128 
0129     yc_varid=netcdf.defVar(nc,<span class="string">'yc'</span>,<span class="string">'NC_FLOAT'</span>,nele_dimid);
0130     netcdf.putAtt(nc,yc_varid,<span class="string">'long_name'</span>,<span class="string">'zonal y-coordinate'</span>);
0131     netcdf.putAtt(nc,yc_varid,<span class="string">'units'</span>,<span class="string">'meters'</span>);
0132 
0133     nv_varid=netcdf.defVar(nc,<span class="string">'nv'</span>,<span class="string">'NC_INT'</span>,[nele_dimid, three_dimid]);
0134     netcdf.putAtt(nc,nv_varid,<span class="string">'long_name'</span>,<span class="string">'nodes surrounding element'</span>);
0135 
0136     <span class="comment">% Time variables</span>
0137     time_varid=netcdf.defVar(nc,<span class="string">'time'</span>,<span class="string">'NC_FLOAT'</span>,time_dimid);
0138     netcdf.putAtt(nc,time_varid,<span class="string">'long_name'</span>,<span class="string">'time'</span>);
0139     netcdf.putAtt(nc,time_varid,<span class="string">'units'</span>,<span class="string">'days since 1858-11-17 00:00:00'</span>);
0140     netcdf.putAtt(nc,time_varid,<span class="string">'format'</span>,<span class="string">'modified julian day (MJD)'</span>);
0141     netcdf.putAtt(nc,time_varid,<span class="string">'time_zone'</span>,<span class="string">'UTC'</span>);
0142 
0143     itime_varid=netcdf.defVar(nc,<span class="string">'Itime'</span>,<span class="string">'NC_INT'</span>,time_dimid);
0144     netcdf.putAtt(nc,itime_varid,<span class="string">'units'</span>,<span class="string">'days since 1858-11-17 00:00:00'</span>);
0145     netcdf.putAtt(nc,itime_varid,<span class="string">'format'</span>,<span class="string">'modified julian day (MJD)'</span>);
0146     netcdf.putAtt(nc,itime_varid,<span class="string">'time_zone'</span>,<span class="string">'UTC'</span>);
0147 
0148     itime2_varid=netcdf.defVar(nc,<span class="string">'Itime2'</span>,<span class="string">'NC_INT'</span>,time_dimid);
0149     netcdf.putAtt(nc,itime2_varid,<span class="string">'units'</span>,<span class="string">'msec since 00:00:00'</span>);
0150     netcdf.putAtt(nc,itime2_varid,<span class="string">'time_zone'</span>,<span class="string">'UTC'</span>);
0151 
0152     <span class="comment">% Since we have a dynamic number of variables in the struct, try to be a</span>
0153     <span class="comment">% bit clever about how to create the output variables.</span>
0154     fnames = fieldnames(data);
0155     used_varids = cell(0);
0156     used_fnames = cell(0);
0157     used_dims = cell(0); <span class="comment">% exclude time (assume all variables vary in time)</span>
0158 
0159     <span class="keyword">for</span> vv=1:length(fnames)
0160         <span class="comment">% Need to check both whether we have the data but also whether</span>
0161         <span class="comment">% we're outputting to several NetCDF files. If so, we drop some</span>
0162         <span class="comment">% variables if we're in the wrong file loop.</span>
0163         <span class="keyword">switch</span> fnames{vv}
0164             <span class="keyword">case</span> {<span class="string">'uwnd'</span>, <span class="string">'u10'</span>}
0165                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_wnd'</span>) || ~multi_out
0166                     <span class="comment">% wind components (assume we have v if we have u)</span>
0167 
0168                     <span class="comment">% On the elements</span>
0169                     u10_varid=netcdf.defVar(nc,<span class="string">'U10'</span>,<span class="string">'NC_FLOAT'</span>,[nele_dimid, time_dimid]);
0170                     netcdf.putAtt(nc,u10_varid,<span class="string">'long_name'</span>,<span class="string">'Eastward Wind Speed'</span>);
0171 <span class="comment">%                     netcdf.putAtt(nc,u10_varid,'standard_name','Eastward Wind Speed');</span>
0172                     netcdf.putAtt(nc,u10_varid,<span class="string">'units'</span>,<span class="string">'m/s'</span>);
0173                     netcdf.putAtt(nc,u10_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0174                     netcdf.putAtt(nc,u10_varid,<span class="string">'coordinates'</span>,<span class="string">''</span>);
0175                     netcdf.putAtt(nc,u10_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0176 
0177                     v10_varid=netcdf.defVar(nc,<span class="string">'V10'</span>,<span class="string">'NC_FLOAT'</span>,[nele_dimid, time_dimid]);
0178                     netcdf.putAtt(nc,v10_varid,<span class="string">'long_name'</span>,<span class="string">'Northward Wind Speed'</span>);
0179 <span class="comment">%                     netcdf.putAtt(nc,v10_varid,'standard_name','Northward Wind Speed');</span>
0180                     netcdf.putAtt(nc,v10_varid,<span class="string">'units'</span>,<span class="string">'m/s'</span>);
0181                     netcdf.putAtt(nc,v10_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0182                     netcdf.putAtt(nc,v10_varid,<span class="string">'coordinates'</span>,<span class="string">''</span>);
0183                     netcdf.putAtt(nc,v10_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0184 
0185                     uwind_varid=netcdf.defVar(nc,<span class="string">'uwind_speed'</span>,<span class="string">'NC_FLOAT'</span>,[nele_dimid, time_dimid]);
0186                     netcdf.putAtt(nc,uwind_varid,<span class="string">'long_name'</span>,<span class="string">'Eastward Wind Speed'</span>);
0187                     netcdf.putAtt(nc,uwind_varid,<span class="string">'standard_name'</span>,<span class="string">'Wind Speed'</span>);
0188                     netcdf.putAtt(nc,uwind_varid,<span class="string">'units'</span>,<span class="string">'m/s'</span>);
0189                     netcdf.putAtt(nc,uwind_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0190                     netcdf.putAtt(nc,uwind_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0191 
0192                     vwind_varid=netcdf.defVar(nc,<span class="string">'vwind_speed'</span>,<span class="string">'NC_FLOAT'</span>,[nele_dimid, time_dimid]);
0193                     netcdf.putAtt(nc,vwind_varid,<span class="string">'long_name'</span>,<span class="string">'Northward Wind Speed'</span>);
0194                     netcdf.putAtt(nc,vwind_varid,<span class="string">'standard_name'</span>,<span class="string">'Wind Speed'</span>);
0195                     netcdf.putAtt(nc,vwind_varid,<span class="string">'units'</span>,<span class="string">'m/s'</span>);
0196                     netcdf.putAtt(nc,vwind_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0197                     netcdf.putAtt(nc,vwind_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0198 
0199                     <span class="comment">% On the nodes</span>
0200 <span class="comment">%                     u10_node_varid=netcdf.defVar(nc,'U10','NC_FLOAT',[node_dimid, time_dimid]);</span>
0201 <span class="comment">%                     netcdf.putAtt(nc,u10_node_varid,'long_name','Eastward 10-m Velocity');</span>
0202 <span class="comment">%                     netcdf.putAtt(nc,u10_node_varid,'standard_name','Eastward Wind Speed');</span>
0203 <span class="comment">%                     netcdf.putAtt(nc,u10_node_varid,'units','m/s');</span>
0204 <span class="comment">%                     netcdf.putAtt(nc,u10_node_varid,'grid','fvcom_grid');</span>
0205 <span class="comment">%                     netcdf.putAtt(nc,u10_node_varid,'type','data');</span>
0206 <span class="comment">%                     netcdf.putAtt(nc,u10_node_varid,'coordinates','');</span>
0207 <span class="comment">%</span>
0208 <span class="comment">%                     v10_node_varid=netcdf.defVar(nc,'V10','NC_FLOAT',[node_dimid, time_dimid]);</span>
0209 <span class="comment">%                     netcdf.putAtt(nc,v10_node_varid,'long_name','Northward 10-m Velocity');</span>
0210 <span class="comment">%                     netcdf.putAtt(nc,v10_node_varid,'standard_name','Northward Wind Speed');</span>
0211 <span class="comment">%                     netcdf.putAtt(nc,v10_node_varid,'units','m/s');</span>
0212 <span class="comment">%                     netcdf.putAtt(nc,v10_node_varid,'grid','fvcom_grid');</span>
0213 <span class="comment">%                     netcdf.putAtt(nc,v10_node_varid,'type','data');</span>
0214 <span class="comment">%                     netcdf.putAtt(nc,v10_node_varid,'coordinates','');</span>
0215 
0216 <span class="comment">%                     % Both node and element centred</span>
0217 <span class="comment">%                     used_varids = [used_varids, {'u10_varid', 'v10_varid', 'u10_node_varid', 'v10_node_varid'}];</span>
0218 <span class="comment">%                     used_fnames = [used_fnames, {'uwnd', 'vwnd', 'uwnd', 'vwnd'}];</span>
0219 <span class="comment">%                     used_dims = [used_dims, {'nElems', 'nElems', 'nNodes', 'nNodes'}];</span>
0220 <span class="comment">%                     % Only on the nodes</span>
0221 <span class="comment">%                     used_varids = [used_varids, {'u10_node_varid', 'v10_node_varid'}];</span>
0222 <span class="comment">%                     used_fnames = [used_fnames, {'uwnd', 'vwnd'}];</span>
0223 <span class="comment">%                     used_dims = [used_dims, {'nNodes', 'nNodes'}];</span>
0224                     <span class="comment">% Only on the elements</span>
0225 <span class="comment">%                     used_varids = [used_varids, {'u10_varid', 'v10_varid'}];</span>
0226 <span class="comment">%                     used_fnames = [used_fnames, {'uwnd', 'vwnd'}];</span>
0227 <span class="comment">%                     used_dims = [used_dims, {'nElems', 'nElems'}];</span>
0228                     <span class="comment">% Only on the elements (both U10/V10 and uwind_speed and</span>
0229                     <span class="comment">% vwind_speed).</span>
0230                     used_varids = [used_varids, {<span class="string">'u10_varid'</span>, <span class="string">'v10_varid'</span>, <span class="string">'uwind_varid'</span>, <span class="string">'vwind_varid'</span>}];
0231                     used_fnames = [used_fnames, {<span class="string">'uwnd'</span>, <span class="string">'vwnd'</span>, <span class="string">'uwnd'</span>, <span class="string">'vwnd'</span>}];
0232                     used_dims = [used_dims, {<span class="string">'nElems'</span>, <span class="string">'nElems'</span>, <span class="string">'nElems'</span>, <span class="string">'nElems'</span>}];
0233                 <span class="keyword">end</span>
0234 
0235             <span class="keyword">case</span> <span class="string">'P_E'</span>
0236                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_evap'</span>) || ~multi_out
0237                     <span class="comment">% Evaporation</span>
0238                     pe_varid=netcdf.defVar(nc,<span class="string">'evap'</span>,<span class="string">'NC_FLOAT'</span>,[node_dimid, time_dimid]);
0239                     netcdf.putAtt(nc,pe_varid,<span class="string">'long_name'</span>,<span class="string">'Evaporation'</span>);
0240                     netcdf.putAtt(nc,pe_varid,<span class="string">'description'</span>,<span class="string">'Evaporation, ocean lose water is negative'</span>);
0241                     netcdf.putAtt(nc,pe_varid,<span class="string">'units'</span>,<span class="string">'m s-1'</span>);
0242                     netcdf.putAtt(nc,pe_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0243                     netcdf.putAtt(nc,pe_varid,<span class="string">'coordinates'</span>,<span class="string">''</span>);
0244                     netcdf.putAtt(nc,pe_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0245 
0246                     used_varids = [used_varids, <span class="string">'pe_varid'</span>];
0247                     used_fnames = [used_fnames, fnames{vv}];
0248                     used_dims = [used_dims, <span class="string">'nNodes'</span>];
0249                 <span class="keyword">end</span>
0250                 
0251             <span class="keyword">case</span> <span class="string">'prate'</span>
0252                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_evap'</span>) || ~multi_out
0253                     <span class="comment">% Precipitation</span>
0254                     prate_varid=netcdf.defVar(nc,<span class="string">'precip'</span>,<span class="string">'NC_FLOAT'</span>,[node_dimid, time_dimid]);
0255                     netcdf.putAtt(nc,prate_varid,<span class="string">'long_name'</span>,<span class="string">'Precipitation'</span>);
0256                     netcdf.putAtt(nc,prate_varid,<span class="string">'description'</span>,<span class="string">'Precipitation, ocean lose water is negative'</span>);
0257                     netcdf.putAtt(nc,prate_varid,<span class="string">'units'</span>,<span class="string">'m s-1'</span>);
0258                     netcdf.putAtt(nc,prate_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0259                     netcdf.putAtt(nc,prate_varid,<span class="string">'coordinates'</span>,<span class="string">''</span>);
0260                     netcdf.putAtt(nc,prate_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0261 
0262                     used_varids = [used_varids, <span class="string">'prate_varid'</span>];
0263                     used_fnames = [used_fnames, fnames{vv}];
0264                     used_dims = [used_dims, <span class="string">'nNodes'</span>];
0265                 <span class="keyword">end</span>
0266 
0267             <span class="keyword">case</span> <span class="string">'nswrs'</span>
0268                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_hfx'</span>) || ~multi_out
0269                     <span class="comment">% Shortwave radiation</span>
0270                     nswrs_varid=netcdf.defVar(nc,<span class="string">'short_wave'</span>,<span class="string">'NC_FLOAT'</span>,[node_dimid, time_dimid]);
0271                     netcdf.putAtt(nc,nswrs_varid,<span class="string">'long_name'</span>,<span class="string">'Short Wave Radiation'</span>);
0272                     netcdf.putAtt(nc,nswrs_varid,<span class="string">'units'</span>,<span class="string">'W m-2'</span>);
0273                     netcdf.putAtt(nc,nswrs_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0274                     netcdf.putAtt(nc,nswrs_varid,<span class="string">'coordinates'</span>,<span class="string">''</span>);
0275                     netcdf.putAtt(nc,nswrs_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0276 
0277                     used_varids = [used_varids, <span class="string">'nswrs_varid'</span>];
0278                     used_fnames = [used_fnames, fnames{vv}];
0279                     used_dims = [used_dims, <span class="string">'nNodes'</span>];
0280                 <span class="keyword">end</span>
0281 
0282             <span class="keyword">case</span> {<span class="string">'shtfl'</span>, <span class="string">'lhtfl'</span>, <span class="string">'nlwrs'</span>}
0283                 <span class="keyword">try</span>
0284                     <span class="comment">% We might have already made this attribute, so fail</span>
0285                     <span class="comment">% elegantly if we do. This is because we need to put</span>
0286                     <span class="comment">% all three of shtfl, lhtfl and nlwrs to make Surface</span>
0287                     <span class="comment">% Net Heat Flux.</span>
0288                     <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_hfx'</span>) || ~multi_out
0289                         <span class="comment">% Surface net heat flux</span>
0290                         nhf_varid=netcdf.defVar(nc,<span class="string">'net_heat_flux'</span>,<span class="string">'NC_FLOAT'</span>,[node_dimid, time_dimid]);
0291                         netcdf.putAtt(nc,nhf_varid,<span class="string">'long_name'</span>,<span class="string">'Surface Net Heat Flux'</span>);
0292                         netcdf.putAtt(nc,nhf_varid,<span class="string">'units'</span>,<span class="string">'W m-2'</span>);
0293                         netcdf.putAtt(nc,nhf_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0294                         netcdf.putAtt(nc,nhf_varid,<span class="string">'coordinates'</span>,<span class="string">''</span>);
0295                         netcdf.putAtt(nc,nhf_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0296                     <span class="keyword">end</span>
0297                 <span class="keyword">end</span>
0298                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_hfx'</span>) || ~multi_out
0299                     <span class="comment">% We need to save the current variable name even if we've</span>
0300                     <span class="comment">% already made its attribute.</span>
0301                     used_varids = [used_varids, <span class="string">'nhf_varid'</span>];
0302                     used_fnames = [used_fnames, fnames{vv}];
0303                     used_dims = [used_dims, <span class="string">'nNodes'</span>];
0304                 <span class="keyword">end</span>
0305                 
0306             <span class="keyword">case</span> {<span class="string">'time'</span>, <span class="string">'lon'</span>, <span class="string">'lat'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>}
0307                 <span class="keyword">continue</span>
0308 
0309             <span class="keyword">otherwise</span>
0310                 <span class="keyword">if</span>(ftbverbose)
0311                     warning(<span class="string">'Unknown or unused input data type: %s'</span>, fnames{vv})
0312                 <span class="keyword">end</span>
0313         <span class="keyword">end</span>
0314     <span class="keyword">end</span>
0315 
0316     <span class="comment">% End definitions</span>
0317     netcdf.endDef(nc);
0318 
0319     <span class="comment">% Put the easy ones in first.</span>
0320     netcdf.putVar(nc,nv_varid, tri');
0321     netcdf.putVar(nc,time_varid,0,ntimes,data.time);
0322     netcdf.putVar(nc,itime_varid,0,ntimes,floor(data.time));
0323     netcdf.putVar(nc,itime2_varid,0,ntimes,mod(data.time,1)*24*3600*1000);
0324     netcdf.putVar(nc,x_varid,x);
0325     netcdf.putVar(nc,y_varid,y);
0326     netcdf.putVar(nc,xc_varid,xc);
0327     netcdf.putVar(nc,yc_varid,yc);
0328 
0329     <span class="comment">% Now do the dynamic ones. Set the heat flux to not done (0) until we</span>
0330     <span class="comment">% hit one of the holy trinity (shtfl, lhtfl, nlwrs).</span>
0331     hf_done = 0;
0332     <span class="keyword">for</span> ff=1:length(used_fnames)
0333         <span class="keyword">if</span> strcmpi(used_fnames{ff}, <span class="string">'shtfl'</span>) || strcmpi(used_fnames{ff}, <span class="string">'lhtfl'</span>) || strcmpi(used_fnames{ff}, <span class="string">'nlwrs'</span>)
0334             hf_done = hf_done + 1;
0335             <span class="keyword">if</span> hf_done == 3
0336                 <span class="comment">% We've got all three heat parameters, so dump them into the file.</span>
0337                 hf = data.shtfl.node + data.lhtfl.node + data.nlwrs.node;
0338                 netcdf.putVar(nc,nhf_varid,[0,0],[nNodes,ntimes],hf)
0339             <span class="keyword">end</span>
0340         <span class="keyword">else</span>
0341             <span class="comment">% One of the other data sets for which we can simply dump the</span>
0342             <span class="comment">% existing array without waiting for other data</span>
0343             <span class="keyword">if</span> strcmpi(used_dims{ff}, <span class="string">'nNodes'</span>)
0344                 eval([<span class="string">'netcdf.putVar(nc,'</span>,used_varids{ff},<span class="string">',[0,0],['</span>,used_dims{ff},<span class="string">',ntimes],data.(used_fnames{ff}).node)'</span>])
0345             <span class="keyword">else</span>
0346                 eval([<span class="string">'netcdf.putVar(nc,'</span>,used_varids{ff},<span class="string">',[0,0],['</span>,used_dims{ff},<span class="string">',ntimes],data.(used_fnames{ff}).data)'</span>])
0347             <span class="keyword">end</span>
0348         <span class="keyword">end</span>
0349     <span class="keyword">end</span>
0350     <span class="keyword">if</span> hf_done ~= 3
0351         warning(<span class="string">'Did not have all the required heat flux parameters. Need ''shtfl'', ''lhtfl'', ''nlwrs'''</span>)
0352     <span class="keyword">end</span>
0353 
0354     <span class="comment">% Close the NetCDF file(s)</span>
0355     netcdf.close(nc);
0356 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 18-Dec-2012 12:37:31 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>